# -*- coding: utf-8 -*-
"""
DayDrawdownPolicy â€” í•˜ë£¨ ëˆ„ì  ì†ì‹¤(ì†ìµë¥ ) ê¸°ë°˜ ì§„ì… ì°¨ë‹¨/ìŠ¤ì¼€ì¼ ë‹¤ìš´/ê°•ì œ ì²­ì‚° ì‹ í˜¸ ì œê³µ

â›³ ëª©ì 
- ë‹¹ì¼ ì†ìµì´ ì„¤ì • ì„ê³„ì¹˜(ì˜ˆ: -2%)ë¥¼ ë„˜ê²Œ ì†ì‹¤ë‚  ê²½ìš°, ì‹ ê·œ ì§„ì…ì„ ì°¨ë‹¨(hold)í•˜ê³  í•„ìš” ì‹œ ì „ëŸ‰ ì²­ì‚°(force_flatten) ì‹ í˜¸ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
- ì†Œí”„íŠ¸ êµ¬ê°„(ì˜ˆ: -1% ~ -2%)ì—ì„œëŠ” í¬ì§€ì…˜ ì‚¬ì´ì¦ˆë¥¼ ì¶•ì†Œ(scale)í•˜ì—¬ ë¦¬ìŠ¤í¬ë¥¼ ë‚®ì¶¥ë‹ˆë‹¤.

ğŸ“¦ ì…ë ¥/ì¶œë ¥ í”„ë¡œí† ì½œ (RiskGateì™€ì˜ ì•½ì†)
- evaluate(context: Dict[str, Any]) -> Dict[str, Any]
  context í•„ë“œ ê¶Œì¥:
    - "is_entry": bool           # Trueë©´ ì‹ ê·œ ì§„ì…, Falseë©´ ì²­ì‚°/ê°ì†Œ ë“±
    - "day_start_equity": float  # ë‹¹ì¼ ì‹œì‘ ì‹œì  ê³„ì • í‰ê°€ê¸ˆì•¡(ë¶„ëª¨)
    - "equity": float            # í˜„ì¬ ê³„ì • í‰ê°€ê¸ˆì•¡
    - "realized_pnl": float      # ë‹¹ì¼ ëˆ„ì  ì‹¤í˜„ ì†ìµ (ì˜µì…˜: ì—†ìœ¼ë©´ ë‚´ë¶€ ìƒíƒœ ì‚¬ìš©)
    - "unrealized_pnl": float    # í˜„ì¬ ë¯¸ì‹¤í˜„ ì†ìµ (ì˜µì…˜)

  ë°˜í™˜ í•„ë“œ:
    - "allow": bool              # í•´ë‹¹ ì •ì±… ê¸°ì¤€ ì‹ ê·œ ì§„ì… í—ˆìš© ì—¬ë¶€
    - "scale": float             # í—ˆìš© ì‹œ í¬ì§€ì…˜ ì‚¬ì´ì¦ˆ ë°°ìœ¨ (0.0~1.0)
    - "reason": str              # ê²°ì • ì‚¬ìœ  (ë¡œê¹…ìš©)
    - "force_flatten": bool      # ê°•ì œ ì²­ì‚° ê¶Œê³  (Gateê°€ ìµœì¢… íŒë‹¨)

ğŸ—‚ï¸ ìƒíƒœ ì €ì¥
- í•˜ë£¨ ë‹¨ìœ„ë¡œ íŒŒì¼ì— realized_pnlì„ ê¸°ë¡í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ì—ë„ ìœ ì§€í•©ë‹ˆë‹¤.
- ê²½ë¡œ ê¸°ë³¸ê°’: state/day_dd_YYYYMMDD.json

ì‚¬ìš© ì˜ˆì‹œ (RiskGate ë‚´ë¶€ í˜¹ì€ ì£¼ì…ë¶€)
    dd = DayDrawdownPolicy(limit_pct=-0.02, soft_pct=-0.01, scale_min=0.3)
    out = dd.evaluate({
        "is_entry": True,
        "day_start_equity": 100_000_000,
        "equity": 99_100_000,
    })

ì‘ì„±: 2025-10-30
"""
from __future__ import annotations
from dataclasses import dataclass
from typing import Dict, Any, Optional
import os
import json
from datetime import datetime


# ===== Config dataclass ======================================================
@dataclass
class DayDDConfig:
    limit_pct: float = -0.02      # í•˜ë“œ ì»·: ì´ ê°’ ì´í•˜ë¡œ ë‚´ë ¤ê°€ë©´ ì‹ ê·œì§„ì… ê¸ˆì§€ + ê°•ì œì²­ì‚° ê¶Œê³ 
    soft_pct: float = -0.01       # ì†Œí”„íŠ¸ êµ¬ê°„ ì‹œì‘: ì´ ê°’ ì´í•˜ë¡œ ë‚´ë ¤ê°€ë©´ scale ì ìš©
    scale_min: float = 0.3        # ì†Œí”„íŠ¸ êµ¬ê°„ í•˜ë‹¨ì—ì„œ ì ìš©í•  ìµœì†Œ ë°°ìœ¨ (soft~limit ì„ í˜• ë³´ê°„)
    use_unrealized: bool = False  # ì†ìµë¥  ê³„ì‚°ì— ë¯¸ì‹¤í˜„ í¬í•¨ ì—¬ë¶€
    state_dir: str = os.path.join("state")


# ===== Implementation ========================================================
class DayDrawdownPolicy:
    def __init__(self, limit_pct: float = -0.02, soft_pct: float = -0.01,
                 scale_min: float = 0.3, use_unrealized: bool = False,
                 state_dir: Optional[str] = None) -> None:
        self.cfg = DayDDConfig(
            limit_pct=limit_pct, soft_pct=soft_pct,
            scale_min=scale_min, use_unrealized=use_unrealized,
            state_dir=state_dir or "state",
        )
        os.makedirs(self.cfg.state_dir, exist_ok=True)
        self._day = self._today()
        self._realized_pnl = self._load_state()  # ë‹¹ì¼ ëˆ„ì  ì‹¤í˜„ ì†ìµ

    # --- public api ---------------------------------------------------------
    def evaluate(self, context: Dict[str, Any]) -> Dict[str, Any]:
        """í•µì‹¬ íŒë‹¨ ë¡œì§. RiskGateê°€ ë§¤ tick/ì£¼ë¬¸ ì „ í˜¸ì¶œ.
        contextì—ì„œ ë‹¤ìŒì„ ìš°ì„  ì‚¬ìš©í•˜ë˜, ì—†ìœ¼ë©´ ë‚´ë¶€ ìƒíƒœ/ë³´ìˆ˜ì  ê°€ì • ì‚¬ìš©.
        """
        self._roll_day_if_needed()

        is_entry = bool(context.get("is_entry", True))
        day_start_equity = float(context.get("day_start_equity", 0.0))
        equity = float(context.get("equity", 0.0))

        # ì†ìµ ì¶”ì •: ìš°ì„ ìˆœìœ„ realized_pnl(context) > ë‚´ë¶€ìƒíƒœ > equity - day_start
        realized_ctx = context.get("realized_pnl")
        realized = float(realized_ctx) if realized_ctx is not None else self._realized_pnl

        unreal = float(context.get("unrealized_pnl", 0.0)) if self.cfg.use_unrealized else 0.0

        # ë¶„ëª¨ê°€ ì—†ìœ¼ë©´ ë³´ìˆ˜ì ìœ¼ë¡œ ì‹ ê·œ ì§„ì…ì„ ë§‰ì§€ ì•Šë˜(ìš´ìš© ê°€ëŠ¥), ë©”ì‹œì§€ ë‚¨ê¹€
        if day_start_equity <= 0:
            return {
                "allow": True,
                "scale": 1.0,
                "reason": "DayDD: day_start_equity=0 (ë¶„ëª¨ ë¶ˆëª…). ì •ì±… ë¯¸ì ìš©.",
                "force_flatten": False,
            }

        # day PnL = realized + (opt) unrealized, ë¶„ëª¨ëŠ” day_start_equity
        day_pnl = realized + unreal if self.cfg.use_unrealized else realized
        day_pnl_pct = day_pnl / day_start_equity

        # 1) í•˜ë“œ ì»·: ì‹ ê·œ ì§„ì… ì°¨ë‹¨ + ê°•ì œì²­ì‚° ê¶Œê³ (ì§„ì… ìš”ì²­ ì‹œ)
        if day_pnl_pct <= self.cfg.limit_pct:
            if is_entry:
                return {
                    "allow": False,
                    "scale": 0.0,
                    "reason": f"DayDD HARD-CUT: {day_pnl_pct:.3%} â‰¤ {self.cfg.limit_pct:.2%}",
                    "force_flatten": True,
                }
            else:
                # ì²­ì‚°/ê°ì†ŒëŠ” í•­ìƒ í—ˆìš©
                return {
                    "allow": True,
                    "scale": 1.0,
                    "reason": f"DayDD HARD-CUT(active): exit allowed (day {day_pnl_pct:.3%})",
                    "force_flatten": True,
                }

        # 2) ì†Œí”„íŠ¸ êµ¬ê°„: ì„ í˜• ìŠ¤ì¼€ì¼ë§ (soft_pct ~ limit_pct ì‚¬ì´)
        if day_pnl_pct <= self.cfg.soft_pct:
            scale = self._linear_scale(day_pnl_pct, self.cfg.soft_pct, self.cfg.limit_pct,
                                       1.0, self.cfg.scale_min)
            if is_entry:
                return {
                    "allow": True,
                    "scale": max(self.cfg.scale_min, min(1.0, scale)),
                    "reason": f"DayDD SOFT-ZONE: {day_pnl_pct:.3%} â‰¤ {self.cfg.soft_pct:.2%} â†’ scale {scale:.2f}",
                    "force_flatten": False,
                }
            else:
                return {
                    "allow": True,
                    "scale": 1.0,
                    "reason": f"DayDD SOFT(active): exit allowed (day {day_pnl_pct:.3%})",
                    "force_flatten": False,
                }

        # 3) ì •ìƒ êµ¬ê°„: í’€ í—ˆìš©
        return {
            "allow": True,
            "scale": 1.0,
            "reason": f"DayDD OK: day {day_pnl_pct:.3%}",
            "force_flatten": False,
        }

    def record_fill(self, realized_pnl_delta: float) -> None:
        """ì²´ê²° ì‹œì ì— ì‹¤í˜„ ì†ìµ ë³€í™”ë¥¼ ì „ë‹¬ë°›ì•„ ë‚´ë¶€ ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸.
        ex) ë§¤ìˆ˜ ì²´ê²° ìˆ˜ìˆ˜ë£ŒëŠ” ë³´í†µ 0ì— ê°€ê¹ê³ , ë§¤ë„ ì²´ê²° ì‹œ realized PnL í™•ì •.
        ì£¼ë¬¸ ë¼ìš°í„°/í¬ì§€ì…˜ ë§¤ë‹ˆì €ì—ì„œ í˜¸ì¶œí•˜ì„¸ìš”.
        """
        self._roll_day_if_needed()
        self._realized_pnl += float(realized_pnl_delta)
        self._save_state()

    # --- helpers ------------------------------------------------------------
    @staticmethod
    def _today() -> str:
        return datetime.now().strftime("%Y%m%d")

    def _state_path(self) -> str:
        return os.path.join(self.cfg.state_dir, f"day_dd_{self._day}.json")

    def _load_state(self) -> float:
        try:
            with open(self._state_path(), "r", encoding="utf-8") as f:
                data = json.load(f)
                return float(data.get("realized_pnl", 0.0))
        except FileNotFoundError:
            return 0.0
        except Exception:
            return 0.0

    def _save_state(self) -> None:
        data = {
            "day": self._day,
            "realized_pnl": self._realized_pnl,
            "saved_at": datetime.now().isoformat(timespec="seconds"),
        }
        try:
            with open(self._state_path(), "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
        except Exception:
            pass

    def _roll_day_if_needed(self) -> None:
        today = self._today()
        if today != self._day:
            # ë‚ ì§œ ë³€ê²½ â†’ ìƒíƒœ ë¦¬ì…‹
            self._day = today
            self._realized_pnl = 0.0
            self._save_state()

    @staticmethod
    def _linear_scale(x: float, x1: float, x2: float, y1: float, y2: float) -> float:
        """x1(soft)~x2(limit) ë²”ìœ„ì—ì„œ y1~y2ë¡œ ì„ í˜• ë³´ê°„.
        x2 < x1 (ì˜ˆ: -2% < -1%) ì¡°ê±´ì´ë¯€ë¡œ ë¶„ëª¨ê°€ ìŒìˆ˜. ë³´ê°„ ê²°ê³¼ëŠ” 0~1 ì‚¬ì´ë¡œ í´ë¨í”„ ê¶Œì¥.
        """
        if x <= x2:
            return y2
        if x >= x1:
            return y1
        # ì„ í˜• ë³´ê°„
        t = (x - x1) / (x2 - x1)
        return y1 + t * (y2 - y1)
